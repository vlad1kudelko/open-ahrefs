# Open Ahrefs

–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–∫—Ä–∞–ø–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

Open Ahrefs ‚Äî —ç—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–±–æ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –≤–µ–±-—Å–∞–π—Ç–æ–≤. –ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Kafka –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á, PostgreSQL –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ Grafana –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

### –°–µ—Ä–≤–∏—Å—ã

- **admin-service** ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ FastAPI, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ –∏ —Ñ–æ–Ω–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Kafka
- **scraper-service** ‚Äî —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–∫—Ä–∞–ø–∏–Ω–≥–∞ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π URL –∏–∑ Kafka –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- **common_schemas** ‚Äî –æ–±—â–∏–µ —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- **Kafka** ‚Äî –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á
- **PostgreSQL** ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **Grafana** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫
- **Prometheus** ‚Äî —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- **Loki** ‚Äî —Å–±–æ—Ä –ª–æ–≥–æ–≤

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å Docker Compose

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Docker Compose:

```bash
# –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (PostgreSQL, Kafka, pgAdmin, Kafka UI)
docker compose up -d

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏ —á–µ—Ä–µ–∑ Makefile
make start_admin      # –ó–∞–ø—É—Å–∫ admin-service
make start_scraper    # –ó–∞–ø—É—Å–∫ scraper-service
make start_grafana    # –ó–∞–ø—É—Å–∫ Grafana

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
make logs_admin
make logs_scraper
make logs_grafana

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
make stop_admin
make stop_scraper
make stop_grafana
```

### –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∞–¥—Ä–µ—Å–∞–º:

- **Admin Service API**: `http://localhost:8000`
- **Kafka UI**: `http://localhost:8082`
- **PgAdmin**: `http://localhost:8081`
- **Grafana**: `http://localhost:3000`

–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:8000/docs`:

![FastAPI Documentation](imgs/fastapi-docs.png)

## ‚ò∏Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Kubernetes

–î–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Helm charts.

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Kubernetes –∫–ª–∞—Å—Ç–µ—Ä
- Helm 3.x
- –î–æ—Å—Ç—É–ø –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤

–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã:

```bash
# Strimzi (Kafka)
helm upgrade --install strimzi-operator \
    oci://quay.io/strimzi-helm/strimzi-kafka-operator \
    --set watchAnyNamespace=true \
    --namespace strimzi-system \
    --create-namespace
```

```bash
# CloudNativePG (Postgres)
helm repo add cnpg https://cloudnative-pg.github.io/charts
helm upgrade --install cnpg-operator \
    cnpg/cloudnative-pg \
    --namespace cnpg-system \
    --create-namespace
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```bash
helm upgrade --install my-base \
    ./my-base \
    --namespace my-app \
    --create-namespace
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
open-ahrefs/
‚îú‚îÄ‚îÄ admin-service/          # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background/     # –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (pipe_pull, pipe_push)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ endpoints/      # REST API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db/             # –ú–æ–¥–µ–ª–∏ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tools/          # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ alembic/            # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ common_schemas/         # –û–±—â–∏–µ —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ scraper-service/        # –°–µ—Ä–≤–∏—Å —Å–∫—Ä–∞–ø–∏–Ω–≥–∞
‚îÇ   ‚îî‚îÄ‚îÄ app/
‚îÇ       ‚îî‚îÄ‚îÄ tools/          # –õ–æ–≥–∏–∫–∞ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞
‚îú‚îÄ‚îÄ k8s/                    # Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏ Helm charts
‚îÇ   ‚îî‚îÄ‚îÄ my-base/            # Helm chart –¥–ª—è –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
‚îú‚îÄ‚îÄ grafana/                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Grafana
‚îÇ   ‚îú‚îÄ‚îÄ dashboards/         # –î–∞—à–±–æ—Ä–¥—ã
‚îÇ   ‚îî‚îÄ‚îÄ *.yml               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îî‚îÄ‚îÄ docker-compose.*.yml    # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

## üîÑ –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á**: –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–∫—Ä–∞–ø–∏–Ω–≥ URL –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ API admin-service
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞**: Admin-service –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç URL –≤ Kafka —Ç–æ–ø–∏–∫ `topic_url`
3. **–°–∫—Ä–∞–ø–∏–Ω–≥**: Scraper-service —á–∏—Ç–∞–µ—Ç URL –∏–∑ Kafka –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫—Ä–∞–ø–∏–Ω–≥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–æ–ø–∏–∫ `topic_res`
5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: Admin-service –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ PostgreSQL

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- Poetry (–¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏)
- Docker –∏ Docker Compose
- Kubernetes –∏ Helm (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω –¥–µ–ø–ª–æ—è)

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# Admin service
cd admin-service
poetry install

# Scraper service
cd scraper-service
poetry install

# Common schemas
cd common_schemas
poetry install
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
cd admin-service
alembic upgrade head
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Prometheus –∏ Grafana:

- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (FastAPI Instrumentator)
- –ú–µ—Ç—Ä–∏–∫–∏ Kafka
- –õ–æ–≥–∏ —á–µ—Ä–µ–∑ Loki
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã –≤ Grafana

### –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

![Grafana Requests](imgs/grafana-requests.png)

### –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–¥–µ—Ä–∂–µ–∫ Kafka

![Grafana Lag](imgs/grafana-lag.png)
